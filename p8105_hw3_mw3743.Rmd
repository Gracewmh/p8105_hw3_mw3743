---
title: "HW3 Visualization and EDA"
author: "Minghui Wang"
date: '`r format(Sys.time(), "%Y-%m-%d")`'
output: github_document
---

```{r setup, echo = FALSE, message = FALSE}
library(tidyverse)
library(patchwork)
library(ggridges)
library(hexbin)
knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d

```
[Homework 3](https://p8105.com/homework_3.html) reinforces ideas in Visualization and [EDA](https://p8105.com/topic_visualization_and_eda.html). Here are the codes focusing on question 1-3.

# Question1 
## Import the data:
```{r import q1 data}
library(p8105.datasets)
data("ny_noaa")
```
## EDA and descriptionn
```{r}
ny_noaa|>
  head() |>
  knitr::kable()

ny_noaa|>
  dim()
```
```{r Initial numeric explorations of id ,message = FALSE}
 ny_noaa |>
  group_by(id) |> 
  summarize(
    n_obs = n())|> 
  arrange(n_obs)

```

```{r Initial numeric explorations of prcp ,message = FALSE}
 ny_noaa |>
  ggplot(aes(x = prcp)) +
  geom_histogram()
```

```{r Initial numeric explorations of snowday,message = FALSE}
 ny_noaa |>
  ggplot(aes(x = snwd)) +
  geom_histogram()

 ny_noaa |>
   filter( snwd >= 50)|>
  ggplot(aes(x = snwd)) +
  geom_histogram()
```

```{r Initial numeric explorations tmax,message = FALSE}

ny_noaa_df = ny_noaa |>
  mutate(
    tmax = as.numeric(tmax) / 10, 
    tmin = as.numeric(tmin) / 10
  ) 

 ny_noaa_df |>
  ggplot(aes(x = tmax)) +
  geom_histogram()


```
```{r Initial numeric explorations tmin,message = FALSE}

 ny_noaa_df |>
  ggplot(aes(x = tmin)) +
  geom_histogram()


```

## Data description
This dataset has 7 variables recording 2595176 entries.The data records different cities' weather information, including key variables like date, precipitation and snow condition, snow day, maxium and mininum temperature at that day.After EDA, we find tha 
precipitation and snow are very skewed distribution; any formal analyses involving them as a predictor or outcome might be influenced by this fact. It’s important to note that the vast majority of days have no precipitation or snow. Meanwhile, examining the relatively few days have very high precipitation and snow might be helpful.

## Answer questions

1. Do some data cleaning. Create separate variables for year, month, and day. Ensure observations for temperature, precipitation, and snowfall are given in reasonable units. 

```{r q1.1 data cleaning}
ny_noaa_cleaned_df =
  ny_noaa_df |> # already change the variable type of tin and tmax in EDA steps.
  drop_na(prcp) |>
  mutate(
    year = year(date) ,
    month = month(date),
    day = day(date)
  ) 
```
- For snowfall, what are the most commonly observed values? Why?
  - For snowfall, the  most commonly observed value are "NA" or zero for it is not common the be snowy alot in New York.

2. Make a two-panel plot showing the average max temperature in January and in July in each station across years.
```{r q1.2  two-panel plot showing the average max temperature in January and in July }
ny_noaa_cleaned_df |>
  filter(month %in% c(1, 7)) |>
  group_by(id, year, month)|>
  summarize(
    mean_tmax = mean(tmax, na.rm = TRUE)) |>
  mutate(
    month_name = case_match(
      month,
      1 ~ "January",
      7 ~ "July"
    )  ) |>
  ggplot(aes(x = year, y = mean_tmax)) + 
  geom_point(alpha = .3) + 
  geom_line()+ 
  facet_grid(. ~ month_name)+
  labs(
    x = "Year", 
    y = "Mean Maximum Temp (C)",
    title = "Average Max Temperature in January and in July in Each Station Across Years",
  ) + 
  theme_minimal() + 
  theme(legend.position = "bottom")
  
```
 - Is there any observable / interpretable structure? Any outliers?
  - Yes. The plot shows that July has higher average maximum temperatures than January over the years, which is expected. There is no big change in temperature trends over time, which suggests stable patterns for these months. However, there are some unusual points, especially in January, where temperatures drop much lower than the others. This might mean there were very cold days or maybe data mistakes. In July, there are fewer unusual points, but one or two cooler days stand out. These unusual points should be checked further to see if they are correct.

3. Make a two-panel plot showing 
(i) tmax vs tmin for the full dataset (note that a scatterplot may not be the best option); 
(ii) make a plot showing the distribution of snowfall values greater than 0 and less than 100 separately by year.

```{r}
ggp_tmax_tmin = 
ny_noaa_cleaned_df |> 
  drop_na(tmax, tmin) |>
  ggplot(aes(x = tmin, y = tmax)) + 
  geom_hex(alpha = .3)+
  labs(
    x = "Minimum Temperature (°F)",
    y = "Maximum Temperature (°F)",
    title = "Relationship Between Tmax and Tmin"
  ) +
  theme_minimal()

ggp_snwd_yr =
  ny_noaa_cleaned_df |> 
  filter(snwd > 0 & snwd < 100) |> 
  ggplot(aes(x = year, y = snwd)) + 
  geom_point(alpha = .3) + 
  geom_smooth(se = FALSE)+
  labs(
    x = "Year",
    y = "Snow Depth (mm)",
    title = "Distribution of Snow Depth for Values Between 0 and 100 mm by Year"
  ) +
  theme_minimal()

ggp_tmax_tmin + ggp_snwd_yr 


```

# Question 2
## 2.1 Load, tidy, merge the datasets
```{r Load tidy merge the datasets}
# Load, tidy the demographic df
accel_demo_df =
  read.csv("data/nhanes_covar.csv",skip = 4, na = c("NA", ".","")) |>
  janitor::clean_names()|>
  # exclude participants less than 21 years of age
  filter(age >= 21)|>
  # exclude  those with missing demographic data
  drop_na()|>
  # encode data with reasonable variable classes
  mutate(
    sex = as.character(sex),        
    sex = case_match(
      sex,
      "1" ~ "male",
      "2" ~ "female"
    ),
    education = as.character(education), 
    education = case_match(
      education,
      "1" ~ "less than high school",
      "2" ~ "high school equivalent",
      "3" ~ "more than high school"
    )
  )

# Load, tidy the Variables df
accel_var_df =
  read.csv("data/nhanes_accel.csv", na = c("NA", ".","")) |>
  janitor::clean_names()|>
  pivot_longer(
    cols = min1:min1440, 
    names_to = "minute",
    values_to = 'mims_value',
  )|>
  mutate(minute = as.numeric(sub("min", "", minute))) 

# Merge to table based on demographic df
accel_df =
  left_join(accel_demo_df, accel_var_df, by = "seqn")

```

## 2.2 Demographic table

### 2.2.1 Table for the number of men and women in each education category, 


```{r the number of men and women in each education category}
accel_df |>  
  group_by(sex, education) |>
  summarize(category_count = n()/1440, .groups = "drop")|>  
  pivot_wider(
    names_from = education,
    values_from  = category_count
    ) |>
  knitr::kable()

```

### 2.2.2 Visualization of the age distributions for men and women in each education category

```{r}
accel_df |>  
  mutate(education = factor(education, levels = c("less than high school", 
                                                  "high school equivalent", 
                                                  "more than high school"))) |>
  ggplot(aes(x = sex, y=age, fill = education)) + 
  geom_boxplot() +
  labs(title = "Age Distributions by Sex and Education Level",
      x = "Sex",
      y = "Age") +
  scale_y_continuous(
    limits = c(20, 85),
    breaks = c(20,30,40,50,60,70,80)
  )+
  scale_fill_brewer(palette = "Set3") +
  theme_minimal()
```
- Comment on these items: 
This box plot shows the age distributions for men and women in different education categories. For both men and women, those with "more than high school" seem to have a slightly younger age range compared to the other two education levels. The median ages for "high school equivalent" are a bit higher for females whild for man ages for "high school equivalent" are a bit lower.

## 2.3 Total activity variable
Using your tidied dataset, aggregate across minutes to create a total activity variable for each participant. Plot these total activities (y-axis) against age (x-axis); your plot should compare men to women and have separate panels for each education level. Include a trend line or a smooth to illustrate differences. Comment on your plot.
```{r}
accel_df |>  
  mutate(education = factor(education, levels = c("less than high school", 
                                                  "high school equivalent", 
                                                  "more than high school"))
         ) |>
  # Create a total activity variable for each participant
  group_by(seqn, sex, age, education) |>
  summarize(total_activities = sum(mims_value, na.rm = TRUE))|>
  # Age-total_activity plot compare men to women 
  ggplot(aes(x = age, y=total_activities, color = sex)) + 
  geom_point(alpha=.3) +
  # Include a trend line or a smooth to illustrate differences
  geom_smooth(se = FALSE) +
  # Have separate panels for each education level
  facet_grid(. ~ education)+ 
  labs(title = "Total Activity vs. Age by Sex and Education Level",
       x = "Age",
       y = "Total Activity") +
  scale_color_brewer(palette = "Set1")+
  theme_minimal()
```
- Comments: This plot shows total activity levels by age for men and women across three education levels. In the "less than high school" group, activity decreases with age, especially for men. The "high school equivalent" group has more ups and downs in activity, while the "more than high school" group shows steadier activity across ages. Women generally have slightly higher activity in younger ages across all levels. Among "high school equivalent" and "more than high school" group, women consistantly have more daily activity than men across all ages.



```{r}

```






